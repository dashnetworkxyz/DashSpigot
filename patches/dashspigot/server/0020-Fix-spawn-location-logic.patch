From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MasterDash5 <constant4337@molecularmail.com>
Date: Mon, 20 Oct 2025 16:25:00 -0600
Subject: [PATCH] Fix spawn location logic


diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index d981c89fd182bae75c928616edc5944f6ee860f8..1fc6a652ae5c53594f1528b9860aead69671029b 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -85,11 +85,31 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
         this.viewDistance = world.spigotConfig.viewDistance; // PaperSpigot - Player view distance API
         playerinteractmanager.player = this;
         this.playerInteractManager = playerinteractmanager;
+        BlockPosition blockposition = getSpawnPoint(minecraftserver, worldserver); // DashSpigot - Move spawn point logic
+
+        this.server = minecraftserver;
+        this.bK = minecraftserver.getPlayerList().a((EntityHuman) this);
+        this.S = 0.0F;
+        this.setPositionRotation(blockposition, 0.0F, 0.0F);
+
+        while (!worldserver.getCubes(this, this.getBoundingBox()).isEmpty() && this.locY < 255.0D) {
+            this.setPosition(this.locX, this.locY + 1.0D, this.locZ);
+        }
+
+        // CraftBukkit start
+        this.displayName = net.kyori.adventure.text.Component.text(this.getName()); // PandaSpigot - Adventure
+        // this.canPickUpLoot = true; TODO
+        this.maxHealthCache = this.getMaxHealth();
+        // CraftBukkit end
+    }
+
+    // DashSpigot start - Move spawn point logic
+    public final BlockPosition getSpawnPoint(MinecraftServer minecraftserver, WorldServer worldserver) {
         BlockPosition blockposition = worldserver.getSpawn();
 
         if (!worldserver.worldProvider.o() && worldserver.getWorldData().getGameType() != WorldSettings.EnumGamemode.ADVENTURE) {
             int i = Math.max(5, minecraftserver.getSpawnProtection() - 6);
-            int j = MathHelper.floor(worldserver.getWorldBorder().b((double) blockposition.getX(), (double) blockposition.getZ()));
+            int j = MathHelper.floor(worldserver.getWorldBorder().b(blockposition.getX(), blockposition.getZ()));
 
             if (j < i) {
                 i = j;
@@ -102,21 +122,9 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
             blockposition = worldserver.r(blockposition.a(this.random.nextInt(i * 2) - i, 0, this.random.nextInt(i * 2) - i));
         }
 
-        this.server = minecraftserver;
-        this.bK = minecraftserver.getPlayerList().a((EntityHuman) this);
-        this.S = 0.0F;
-        this.setPositionRotation(blockposition, 0.0F, 0.0F);
-
-        while (!worldserver.getCubes(this, this.getBoundingBox()).isEmpty() && this.locY < 255.0D) {
-            this.setPosition(this.locX, this.locY + 1.0D, this.locZ);
-        }
-
-        // CraftBukkit start
-        this.displayName = net.kyori.adventure.text.Component.text(this.getName()); // PandaSpigot - Adventure
-        // this.canPickUpLoot = true; TODO
-        this.maxHealthCache = this.getMaxHealth();
-        // CraftBukkit end
+        return blockposition;
     }
+    // DashSpigot end
 
     public void a(NBTTagCompound nbttagcompound) {
         super.a(nbttagcompound);
diff --git a/src/main/java/net/minecraft/server/PlayerList.java b/src/main/java/net/minecraft/server/PlayerList.java
index a82a78278b16088caa7e33449035e4023bfd92b7..07b0542add5d4df514a9f90a6ec6116d0000d01f 100644
--- a/src/main/java/net/minecraft/server/PlayerList.java
+++ b/src/main/java/net/minecraft/server/PlayerList.java
@@ -583,7 +583,7 @@ public abstract class PlayerList {
 
             if (location == null) {
                 cworld = (CraftWorld) this.server.server.getWorlds().get(0);
-                blockposition = cworld.getHandle().getSpawn();
+                blockposition = entityplayer1.getSpawnPoint(this.server, cworld.getHandle()); // DashSpigot - Randomize spawn position
                 location = new Location(cworld, blockposition.getX() + 0.5, blockposition.getY(), blockposition.getZ() + 0.5);
             }
 
@@ -678,9 +678,12 @@ public abstract class PlayerList {
         if (exitWorld != null) {
             if ((cause == TeleportCause.END_PORTAL) && (i == 0)) {
                 // THE_END -> NORMAL; use bed if available, otherwise default spawn
-                exit = ((org.bukkit.craftbukkit.entity.CraftPlayer) entityplayer.getBukkitEntity()).getBedSpawnLocation();
+                exit = ((org.bukkit.craftbukkit.entity.CraftPlayer) entityplayer.getBukkitEntity()).getBedSpawnLocation().add(0.5, 0.10000000149011612, 0.5); // DashSpigot - Fix bed location
                 if (exit == null || ((CraftWorld) exit.getWorld()).getHandle().dimension != 0) {
-                    exit = exitWorld.getWorld().getSpawnLocation();
+                    // DashSpigot start - Randomize spawn position
+                    BlockPosition randomSpawn = entityplayer.getSpawnPoint(this.server, exitWorld);
+                    exit = new Location(exitWorld.getWorld(), randomSpawn.getX(), randomSpawn.getY(), randomSpawn.getZ());
+                    // DashSpigot end
                 }
             } else {
                 // NORMAL <-> NETHER or NORMAL -> THE_END
@@ -718,7 +721,7 @@ public abstract class PlayerList {
         exitWorld.getTravelAgent().adjustExit(entityplayer, exit, velocity);
         exitWorld.chunkProviderServer.forceChunkLoad = before;
 
-        this.moveToWorld(entityplayer, exitWorld.dimension, true, exit, false); // Vanilla doesn't check for suffocation when handling portals, so neither should we
+        this.moveToWorld(entityplayer, exitWorld.dimension, true, exit, cause == TeleportCause.END_PORTAL && i == 0); // Vanilla doesn't check for suffocation when handling portals, so neither should we // DashSpigot - Check for suffocation on THE_END -> NORMAL
         // DashSpigot start - Fix MC-233: Portal travel sound doesn't play
         if (cause == TeleportCause.NETHER_PORTAL) {
             entityplayer.playerConnection.sendPacket(new PacketPlayOutNamedSoundEffect("portal.travel", entityplayer.locX, entityplayer.locY, entityplayer.locZ, 0.25F, entityplayer.random.nextFloat() * 0.4F + 0.8F));
